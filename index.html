<!--

  If you are reading this:

  This was written in 48 hours, the code is atrocious.

  If there's something you see that you like, email us: who@tree.is
  And we'll try to make it easier to understand!!!

  Also, please follow us on twitter:

  @vrtree , @lukexi , @cabbibo


-->

<html>

  <head>
    <style>
      body{ margin: 0px;  background:#000;}
      html{ overflow: hidden }


    </style>
  </head>

  <body>

    <!--<div id="text">
      <h1> BABY JESUS </h1>
    </div>-->

    <script src = "lib/three.min.js"                ></script>
    <script src = "lib/jquery.min.js"               ></script>
    <script src = "lib/ShaderLoader.js"             ></script>
    <script src = "lib/stats.min.js"                ></script>

    <script src = "lib/TrackballControls.js"        ></script>
    <script src = "lib/MouseMoveControls.js"        ></script>
    <script src = "lib/ObjectControls.js"           ></script>
    

    <script src = "lib/Link.js"           ></script>
    <script src = "lib/underscore.js"     ></script>



    <script src = "PhysicsRenderer.js"          ></script>


    <script src = "AudioController.js"          ></script>
    <script src = "AudioBuffer.js"              ></script>
    <script src = "BufferedAudio.js"            ></script>
    <script src = "Grain.js"                    ></script>


    <script src = "Tree.js" ></script>


    <!-- moving extra functions out, for clutter sake -->
    <script src = "keydown.js"              ></script>
    <script src = "textStuff.js" ></script>
    <script src = "makeThings.js" ></script>
    <script src = "makeSnowflakes.js" ></script>




    <script>

    var frameSlow = 6;
    var counter = 0;

    var neededToLoad = 2;
    var loaded = 0;

    var FIRST_FRAME;

    var moving = false;

    var camera, renderer, scene , controls , clock;
    
    var audioMesh;

    var dissipationFactor = .9;

    /*

  
        SHADRES SHADRES SHADRES SHADRES SHADRES SHADRES 


    */

    // Setting up shaders
    var shaders = new ShaderLoader( 'shaders' );

    shaders.shaderSetLoaded = function(){
      onLoad();
    }


    shaders.load( 'vs-holo' , 'raytrace' , 'vertex'   );
    shaders.load( 'vs-uv' , 'basic' , 'vertex'   );

    shaders.load( 'fs-tree' , 'tree' , 'fragment' );
    shaders.load( 'fs-noglo' , 'noglo' , 'fragment' );
    shaders.load( 'fs-monk' , 'monk' , 'fragment' );

    shaders.load( 'fs-sky' , 'sky' , 'fragment'   );
    shaders.load( 'fs-spirit' , 'spirit' , 'fragment'   );
    shaders.load( 'fs-floor' , 'floor' , 'fragment'   );
    shaders.load( 'fs-pedestal' , 'pedestal' , 'fragment'   );


    // SNOFLAX
    shaders.load( 'ss-sdf'    , 'sim'    , 'simulation' );
    shaders.load( 'fs-splat'  , 'splat' , 'fragment'   );
    shaders.load( 'vs-splat'  , 'splat' , 'vertex'   );

    //shaders.load( 'fs-bg' , 'bg' , 'fragment' );

    lookPosition = new THREE.Vector3();

    // Normals For the Material
    var uniforms = {

      dT:       { type:"f"  , value : 0             },
      time:     { type:"f"  , value : 0             },
      
      t_audio : {type:"t" , value: null},
      lightPosition: { type:"v3" , value : new THREE.Vector3() },

      iModelMat:{ type:"m4" , value: new THREE.Matrix4() },
      lookPosition:  { type:"v3" , value : lookPosition },

      uPower : {type:"f", value :0}


    }





    /*

  
        AUDIO AUDIO AUDIO AUDIO AUDIO AUDIO 


    */

    var audio = new AudioController();

    //audio.mute.gain.value = 0;

    var audioBuffers = [];

    var audioBuffer = new AudioBuffer( audio.ctx , "holyNoises.mp3" );

    audioBuffer.addLoadEvent( function(){
      onLoad();
    });

    audioBuffers.push( audioBuffer );

    uniforms.t_audio.value = audio.texture









    /*

      INIT INIT INIT INIT INIT INIT INIT INIT INIT INIT 

    */

    function init(){


      grain = new Grain( audio , audioBuffers[0].buffer , audio.gain );

      /*


         Setting up THREE.js Scene


      */

      var w = window.innerWidth;
      var h = window.innerHeight;

      camera = new THREE.PerspectiveCamera( 65 , w/h , .1 , 10000 );
      camera.position.z = 40.5;
      //camera.position.x = 3.5;

      scene = new THREE.Scene();

      var dpr = window.devicePixelRatio || 1;
      renderer = new THREE.WebGLRenderer();
      renderer.setPixelRatio( dpr );
      renderer.setSize( window.innerWidth , window.innerHeight );

      renderer.domElement.id = "renderer"
      document.body.appendChild( renderer.domElement );


      stats = new Stats();
      stats.domElement.style.position = "absolute";
      stats.domElement.style.left = "0px";
      stats.domElement.style.bottom = "-30px";
      stats.domElement.style.zIndex = "999";
      document.body.appendChild( stats.domElement );

      window.addEventListener( 'resize', onWindowResize, false );
      window.addEventListener( 'keydown', keydown, false );

      clock = new THREE.Clock();


      //controls = new THREE.MouseMoveControls( camera );
      controls = new THREE.TrackballControls( camera );

      objectControls = new ObjectControls( camera );





      /*

        CREATING SCENE

      */
      treeObj = new THREE.Object3D();


      var treeMat = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.raytrace,
        fragmentShader: shaders.fs.tree
      })

     // treeMat = new THREE.MeshNormalMaterial();

     var rSeed = Math.random();
      var treeParams = {
        material:               treeMat,
        radius:                 1.5,
        height:                 6 + rSeed * 4,
        sides:                  10,
        numOf:                  20, 
        randomness:             1.4,
        slices:                 100,
        lightPosition:          new THREE.Vector3(-1 , 8.1 , 1),
        lightSize:              4,

        startingChance:          20.,
        chanceReducer:           .9,
        randomnessReducer:       .9,
        sliceReducer:            .7,
        numOfReducer:            .6,
        progressionPower:        2.2,
        lengthReduction:         .4 + .5 - rSeed * .5,
        maxIterations:           3,
        flattening:              1.,

        maxVerts:      10000000
      }



      treeMesh = new Tree( treeParams )
      ground = makeGround( treeParams );
      light = makeLight( treeParams );
      pedestal = makePedestal( treeParams );


      var l = new THREE.PointLight( 0xffffff, .5, 40);
      l.position.copy( light.position );


      snowflakes = makeSnowflakes(256);

      treeObj.add( l );
      treeObj.add( ground );
      treeObj.add( treeMesh );
      treeObj.add( light );
      treeObj.add( pedestal );
      treeObj.add( snowflakes.body );

      treeObj.position.y = -10;
      treeObj.position.x = 0;
      //treeObj.position.z = -3;


      scene.add( treeObj )



      cubeCamera = new THREE.CubeCamera(  treeParams.lightSize / 1.3, 100, 1024  ); 
      cubeCamera.renderTarget.minFilter = THREE.LinearMipMapLinearFilter; // mipmap filter
      cubeCamera.position.copy( light.position );
      treeObj.add( cubeCamera );



      balls = createBalls( treeMesh.cleanCurves )



      var m = extraMesh();
      //treeObj.add( m );

      monk = createMonk();

      treeObj.add( monk );


      light.visible = false; // *cough*
      cubeCamera.updateCubeMap( renderer, scene );
      light.visible = true;

      light.material.uniforms.cubeMap.value = cubeCamera.renderTarget;




    }

  
    
    function animate(){

      requestAnimationFrame( animate );

      //}
     
      stats.update();
      audio.update();



      uniforms.dT.value = clock.getDelta();
      uniforms.time.value += uniforms.dT.value;

      snowflakes.soul.update();



      treeObj.rotation.y += uniforms.dT.value * .5 * Math.abs( uniforms.uPower.value );

      ///uniforms.lightPosition.value.set( 1 , 1 , 1  );

      treeMesh.updateMatrixWorld();
      uniforms.iModelMat.value.getInverse( treeMesh.matrixWorld );

      light.updateMatrixWorld();
      light.material.uniforms.iModelMat.value.getInverse( light.matrixWorld );


      ground.updateMatrixWorld();
      ground.material.uniforms.iModelMat.value.getInverse( ground.matrixWorld );

      pedestal.updateMatrixWorld();
      pedestal.material.uniforms.iModelMat.value.getInverse( pedestal.matrixWorld );
      var v1 = light.position.clone();

      //console.log( v1  );
      v1.applyMatrix4( light.matrixWorld );

      uniforms.lightPosition.value.copy( v1 );
     // console.log( v1 );

      monk.updateMatrixWorld();
      monk.material.uniforms.iModelMat.value.getInverse( monk.matrixWorld );

      //light.lookAt( lookPosition )

      for( var i = 0; i < balls.length; i++ ){
       // balls[i].position.x += Math.sin( uniforms.time.value * .1 ) * .01;
        balls[i].updateMatrixWorld();
        balls[i].material.uniforms.iModelMat.value.getInverse( balls[i].matrixWorld );

        balls[i].position.y  += Math.sin( uniforms.time.value * (20 + i) * .1 + i ) * .005;

        balls[i].scale.y = audio.audioData[i*4] * .2 + 1.
        balls[i].scale.x = audio.audioData[i*4+1] * .2 + 1.
        balls[i].scale.z = audio.audioData[i*4+1] * .2 + 1.

      }

   

      uniforms.uPower.value *= dissipationFactor;

     // if( uniforms.uPower.value < 0. ) uniforms.uPower.value = 0.;

      //treeObj.rotation.y += uniforms.dT.value;

      //controls.update();
      objectControls.update();

      if( !FIRST_FRAME ){
        //tree.hoverOut();
        FIRST_FRAME = true;
      }


      var angle = uniforms.time.value * .1;
     /* camera.position.x = Math.sin( angle ) * 20.;
      camera.position.z = Math.cos( angle ) * 20.;

      camera.lookAt(new THREE.Vector3());*/

      counter ++;

      //if( counter == frameSlow ){
        counter = 0;
        renderer.render( scene , camera );
      //}

    }

    function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}



    function onLoad(){
      loaded ++;
      if( loaded == neededToLoad ){ init(); animate(); }

    }

    </script>

  </body>
</html>
