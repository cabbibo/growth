<!--

  If you are reading this:

  This code isn't very nice to look at :)

  If there's something you see that you like, email us: who@tree.is
  And we'll try to make it easier to understand!!!

  Most of the shader code come from: https://www.shadertoy.com/view/ltlSRl
  Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License

  by Adam27 : https://www.shadertoy.com/user/adam27

-->

<html>

  <head>
    <style>
      body{ margin: 0px;  background:#000;}
      html{ overflow: hidden }
      h1{
        color:#111;
        position:absolute;
        width:100%;
        bottom:20%;
        text-align: center;
        font-family: "Trebuchet MS", Helvetica, sans-serif;
      }
      h1:hover{

        text-decoration: underline;
        color:#666;
      }

      #renderer{
       /// border-top: 1px solid white;
        //border-bottom: 1px solid white;

        //left:0%;
        //top:10%;
        //position:absolute;
      }
    </style>
  </head>

  <body>
 
    <script src = "lib/three.min.js"                ></script>
    <script src = "lib/jquery.min.js"               ></script>
    <script src = "lib/ShaderLoader.js"             ></script>
    <script src = "lib/stats.min.js"                ></script>

    <script src = "lib/TrackballControls.js"        ></script>
    <script src = "lib/MouseMoveControls.js"        ></script>
    <script src = "lib/ObjectControls.js"           ></script>
    

    <script src = "lib/Link.js"           ></script>
    <script src = "lib/underscore.js"     ></script>

    <script src = "AudioController.js"              ></script>
    <script src = "AudioBuffer.js"              ></script>
    <script src = "BufferedAudio.js"            ></script>
    <script src = "Grain.js"                    ></script>


    <script src = "Tree.js" ></script>
    <script src = "textStuff.js" ></script>




    <script>

    var frameSlow = 6;
    var counter = 0;

    var neededToLoad = 2;
    var loaded = 0;

    var FIRST_FRAME;

    var moving = false;

    var camera, renderer, scene , controls , clock;
    
    var audioMesh;

    // Setting up shaders
    var shaders = new ShaderLoader( 'shaders' );

    shaders.shaderSetLoaded = function(){
      onLoad();
    }



    shaders.load( 'vs-holo' , 'raytrace' , 'vertex'   );
    shaders.load( 'fs-tree' , 'tree' , 'fragment' );
    shaders.load( 'fs-noglo' , 'noglo' , 'fragment' );

    //shaders.load( 'fs-bg' , 'bg' , 'fragment' );


    // Normals For the Material
    var uniforms = {

      dT:       { type:"f"  , value : 0             },
      time:     { type:"f"  , value : 0             },
      
      t_audio : {type:"t" , value: null},
      lightPosition: { type:"v3" , value : new THREE.Vector3() },

      iModelMat:{ type:"m4" , value: new THREE.Matrix4() }


    }


    /*

       Setting up Audio

    */
    var audio = new AudioController();

    //var stream = new Stream( "held.mp3" , audio.ctx , audio.gain );

   // var userAudio = new UserAudio( audio.ctx , audio.gain);

    //audio.mute.gain.value = 0;

    var audioBuffers = [];

    var audioBuffer = new AudioBuffer( audio.ctx , "holyNoises.mp3" );

    audioBuffer.addLoadEvent( function(){
      onLoad();
    });

    audioBuffers.push( audioBuffer );

    uniforms.t_audio.value = audio.texture






    function init(){


      grain = new Grain( audio , audioBuffers[0].buffer , audio.gain );

      //textCreator = new TextCreator( 3 );


      /*


         Setting up THREE.js Scene


      */

      var w = window.innerWidth;
      var h = window.innerHeight;

      camera = new THREE.PerspectiveCamera( 65 , w/h , .1 , 10000 );
      camera.position.z = 20.5;
      //camera.position.x = 3.5;

      scene = new THREE.Scene();

      var dpr = window.devicePixelRatio || 1;
      renderer = new THREE.WebGLRenderer();
      renderer.setPixelRatio( dpr );
      renderer.setSize( window.innerWidth , window.innerHeight );

      renderer.domElement.id = "renderer"
      document.body.appendChild( renderer.domElement );


      stats = new Stats();
      stats.domElement.style.position = "absolute";
      stats.domElement.style.left = "0px";
      stats.domElement.style.bottom = "-30px";
      stats.domElement.style.zIndex = "999";
      document.body.appendChild( stats.domElement );

      window.addEventListener( 'resize', onWindowResize, false );
      window.addEventListener( 'keydown', keydown, false );

      clock = new THREE.Clock();


      controls = new THREE.MouseMoveControls( camera );
      //controls = new THREE.TrackballControls( camera );

      objectControls = new ObjectControls( camera );


      treeObj = new THREE.Object3D();


      var treeMat = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: shaders.vs.raytrace,
        fragmentShader: shaders.fs.tree
      })

     // treeMat = new THREE.MeshNormalMaterial();

      var treeParams = {
        material:               treeMat,
        radius:                 1.5,
        height:                 10,
        sides:                  10,
        numOf:                  20, 
        randomness:             1.2,
        slices:                 100,
        lightPosition:          new THREE.Vector3(-1 , 8.1 , 1),
        lightSize:              4,

        startingChance:          20.,
        chanceReducer:           .9,
        randomnessReducer:       .95,
        sliceReducer:            .7,
        numOfReducer:            .6,
        progressionPower:        2.2,
        lengthReduction:         .5,
        maxIterations:           3,
        flattening:              .2,

        maxVerts:      10000000
      }


      treeMesh = new Tree(treeParams)



      //treeMesh.position.y = -5




      ground = new THREE.Mesh( new THREE.PlaneGeometry( 100 , 100 , 100 , 100 ) , new THREE.MeshLambertMaterial({color:0xffffff}) );
      ground.rotation.x = -Math.PI/2;
      ground.position.y = 1;


      objectControls.add( ground );

      treeObj.add( ground );
      treeObj.add( treeMesh );

      treeObj.position.y = -8;
      treeObj.position.x = 10;
      //treeObj.position.z = -3;



      scene.add( treeObj )



     


      var lightMat = new THREE.ShaderMaterial({
        uniforms:{
          t_audio: uniforms.t_audio,
          time: uniforms.time,
          dT: uniforms.dT,
          lightPosition: uniforms.lightPosition,
          iModelMat:{ type:"m4" , value: new THREE.Matrix4() },
          cubeMap : {type:"t" , value:null},
        },
        vertexShader: shaders.vs.raytrace,
        fragmentShader: shaders.fs.noglo,
        transparent: true,
        //opacity: 1.,

      })

      light = new THREE.Mesh( new THREE.IcosahedronGeometry( treeParams.lightSize * .8 , 4 ), lightMat );
      light.position.copy( treeParams.lightPosition )


      objectControls.add(light );

      uniforms.lightPosition.value.copy( light.position );
      treeObj.add( light );

      var l = new THREE.PointLight( 0xffffff, .5, 40);
      l.position.copy( light.position );

      treeObj.add( l );

      //grain.hold()


      cubeCamera = new THREE.CubeCamera(  treeParams.lightSize / 1.3, 100, 1024  ); // parameters: near, far, resolution
      cubeCamera.renderTarget.minFilter = THREE.LinearMipMapLinearFilter; // mipmap filter
      cubeCamera.position.copy( light.position );
      //cubeCamera.position.add( treeObj.position );
      treeObj.add( cubeCamera );



 console.log( treeMesh.curves.length )
      console.log( treeMesh.cleanCurves.length )
      createBalls( treeMesh.cleanCurves )



      var m = extraMesh();
      treeObj.add( m );

      light.visible = false; // *cough*
      cubeCamera.updateCubeMap( renderer, scene );
      light.visible = true;

      light.material.uniforms.cubeMap.value = cubeCamera.renderTarget;





    }

  
    
    function animate(){

      requestAnimationFrame( animate );

      //}
     
      stats.update();
      uniforms.dT.value = clock.getDelta();
      uniforms.time.value += uniforms.dT.value;

      uniforms.lightPosition.value.set( 1 , 1 , 1  );

      treeMesh.updateMatrixWorld();
      uniforms.iModelMat.value.getInverse( treeMesh.matrixWorld );

      light.updateMatrixWorld();
      light.material.uniforms.iModelMat.value.getInverse( light.matrixWorld );

      audio.update();

      //treeObj.rotation.y += uniforms.dT.value;

      controls.update();
      objectControls.update();

      if( !FIRST_FRAME ){
        //tree.hoverOut();
        FIRST_FRAME = true;
      }


      var angle = uniforms.time.value * .1;
     /* camera.position.x = Math.sin( angle ) * 20.;
      camera.position.z = Math.cos( angle ) * 20.;

      camera.lookAt(new THREE.Vector3());*/

      counter ++;

      //if( counter == frameSlow ){
        counter = 0;
        renderer.render( scene , camera );
      //}

    }

    function keydown( e ) {
      //console.log( e )
      if( e.keyCode == 82 )
        renderer.render( scene , camera );

      console.log( e.keyCode )

      if( e.keyCode == 49 ){ uniforms.parameter1.value  += .1 }
      if( e.keyCode == 81 ){ uniforms.parameter1.value  -= .1 }

      if( e.keyCode == 50 ){ uniforms.parameter2.value  += .1 }
      if( e.keyCode == 87 ){ uniforms.parameter2.value  -= .1 }

      if( e.keyCode == 51 ){ uniforms.parameter3.value  += .1 }
      if( e.keyCode == 69 ){ uniforms.parameter3.value  -= .1 }

      if( e.keyCode == 52 ){ uniforms.parameter4.value  += .1 }
      if( e.keyCode == 82 ){ uniforms.parameter4.value  -= .1 }

      if( e.keyCode == 53 ){ uniforms.parameter5.value  += .1 }
      if( e.keyCode == 84 ){ uniforms.parameter5.value  -= .1 }

      if( e.keyCode == 54 ){ uniforms.parameter6.value  += .1 }
      if( e.keyCode == 89 ){ uniforms.parameter6.value  -= .1 }

      if( e.keyCode == 32 ){ toggleMovement(); }

    }

    function toggleMovement(){

      moving = !moving;

    }


    function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize( window.innerWidth, window.innerHeight );

		}


    function createBalls(){

      var ball = new THREE.Mesh( new THREE.BoxGeometry( 1 , 5 , 1 ) , new THREE.MeshBasicMaterial());


      var p = new THREE.Vector3();

      for( var i = 0; i < 10; i++ ){
        var b = ball.clone();

        b.position.x = (Math.random()-1.3 ) * 20.
        b.position.z = (Math.random()-.5 ) * 20.
        b.position.y = Math.random() * 2.5;

        b.scale.x = Math.random() * .8 + .2;
        b.scale.z = b.scale.x;

     

        b.audioParams = {

          baseOffset: Math.random() * .8,
          attack    : .140 * 4.,
          release   : .140 * 10.3,
          trans     : .3// + Math.random() * .5

        }

        b.hoverOver = function(){
          grain.playNote( this.audioParams );
                light.visible = false; // *cough*
      cubeCamera.updateCubeMap( renderer, scene );
      light.visible = true;

        }

        treeObj.add( b );
        objectControls.add( b );

      }


    }
    function onLoad(){
      loaded ++;
      if( loaded == neededToLoad ){ init(); animate(); }

    }

    function extraMesh(){

      var m = new THREE.Mesh( new THREE.IcosahedronGeometry( 30 , 3 ), new THREE.MeshLambertMaterial({
        color: 0xffffff,
        side: THREE.BackSide,
        transparent: true,
        opacity: .4,
      //  depthWrite: false,
        blending: THREE.AdditiveBlending
      }));
      m.position.y = 5.;

      return m;

    }



    </script>

  </body>
</html>
